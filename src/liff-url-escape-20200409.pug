extends /layouts/default

block beforehtml
  - var title = 'LIFF 沒有 escape 的錯誤'

block style
  style
    :sass
      [v-cloak]
        display: none

block content
  #app.container.my-3(v-cloak)
    h2.text-center.my-3= title
    h4 請將此連結複製到聊天視窗內貼上再打開
    .input-group.mb-3
      input.form-control(type="url", ref="liff", :value="liff", readonly)
      .input-group-append
        button.btn.btn-outline-success(type="button", @click="btnCopy") 複製
        a.btn.btn-outline-success(:href="liff") 開啟
    h4 參數帶入結果
    pre #[code.language-json {{ code }}]
    h4 Google Maps 的網址應該要是
    pre #[code.language-text {{ gmap }}]

block script
  script(src="https://cdn.jsdelivr.net/npm/vconsole@3/dist/vconsole.min.js")
  script(src="https://static.line-scdn.net/liff/edge/2.1/sdk.js")
  script.
    const vConsole = new VConsole() // eslint-disable-line
    const genGoogleMapUrl = (query, queryPlaceId) => {
      const gmap = new URL('https://www.google.com/maps/search/')
      gmap.searchParams.set('api', '1')
      gmap.searchParams.set('query', query)
      if (queryPlaceId) gmap.searchParams.set('query_place_id', queryPlaceId)
      return gmap.href
    }
    const vm = new Vue({
      el: '#app',
      data: {
        code: '',
        gmap: genGoogleMapUrl('24.959276,121.419008', 'ChIJ40_T2-scaDQRF36Y2c_qORY'),
        liff: '',
      },
      async mounted () {
        await liff.init({ liffId: '1654046335-48OjmpAl' })
        this.liff = this.genLiffUrl(this.gmap)
        const liffState = this.getSearchParams(location.href, 'liff.state')
        this.code = JSON.stringify({
          locationSearch: location.search,
          liffState,
          gmapFromLiffState: this.getSearchParams(new URL(liffState, 'https://localhost'), 'u'),
          gmapFromLocationSearch: this.getSearchParams(location.href, 'u'),
        }, null, 2)
      },
      methods: {
        getSearchParams (url, name) {
          return new URL(url).searchParams.get(name)
        },
        genLiffUrl (u) {
          const url = new URL('https://liff.line.me/1654046335-48OjmpAl/pug/liff-url-escape-20200409.html')
          url.searchParams.set('u', u)
          return url.href
        },
        async btnCopy () {
          const copyText = this.$refs.liff
          copyText.select()
          copyText.setSelectionRange(0, 99999) // For mobile devices
          document.execCommand("copy")
          await Swal.fire({
            icon: 'success',
            title: '複製成功',
          })
        },
      },
    })